<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Australia Chill Trip 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .add-zone { opacity: 0; transition: all 0.2s ease; }
        .add-zone:hover { opacity: 1; height: 30px; }
        .is-dragging { opacity: 0.4; border: 2px dashed #3D9FBD; background: #0f172a; filter: grayscale(100%); }
        .drag-over-target { border-top: 60px solid rgba(61, 159, 189, 0.15) !important; transition: border-top 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; }
        .drag-over-target::before { content: "Drop Here"; position: absolute; top: -45px; left: 0; right: 0; text-align: center; color: #3D9FBD; font-size: 10px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; pointer-events: none; }
        @keyframes popBounce { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 50% { transform: scale(1.02); box-shadow: 0 0 20px 0 rgba(52, 211, 153, 0.4); border-color: #34d399; } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        .pop-success { animation: popBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; text-align: center; }
        .dnd-poly-drag-image { opacity: 0.95 !important; background: #1e293b !important; border-radius: 12px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6); padding: 0; width: 300px !important; border: 2px solid #3D9FBD; transform: scale(1.05) rotate(2deg); }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0.5; } }
        .save-indicator { animation: fadeOut 2s ease-out forwards; }
        /* Highlight Style */
        .highlight { background-color: rgba(234, 179, 8, 0.4); color: #fff; border-radius: 2px; padding: 0 2px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>
    <script>
        var MobileDragDrop = MobileDragDrop || {};
        MobileDragDrop.polyfill({ dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride, holdToDrag: 150, iterationIntervalMs: 50 });
        document.addEventListener("touchmove", function(e) {}, {passive: false});
    </script>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const Plane = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12h20"/><path d="M13 2l9 10-9 10"/><path d="M2 12l5-5m0 10l-5-5"/></svg>);
        const Camera = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>);
        const Utensils = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>);
        const Bed = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg>);
        const MapPin = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>);
        const ChevronUp = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>);
        const ImageIcon = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>);
        const Plus = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const Trash2 = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>);
        const GripVertical = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>);
        const Check = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>);
        const Edit2 = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>);
        const MapIcon = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="3 11 22 2 13 21 11 13 3 11"/><line x1="11" x2="13" y1="13" y2="21"/></svg>);
        const CloudCheck = ({ size = 12, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 18h8a4 4 0 0 0 3.8-5 4.5 4.5 0 0 0-4.3-4.3 4.5 4.5 0 0 0-3.1 1.3"/><path d="M15.7 9A6 6 0 0 0 2.5 11.5A4.5 4.5 0 0 0 5 18H5"/><path d="m9 13 2 2 4-4"/></svg>);
        const SearchIcon = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>);
        const XIcon = ({ size = 16, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>);

        // --- Config ---
        const LOCAL_STORAGE_KEY = "australia-trip-master-data"; 
        const PRIMARY_COLOR = "#3D9FBD";
        const TRIP_START_DATE = "2026-02-13"; 
        const DATE_TABS = [
            { label: "2/13", iso: "2026-02-13" }, { label: "2/14", iso: "2026-02-14" },
            { label: "2/15", iso: "2026-02-15" }, { label: "2/16", iso: "2026-02-16" },
            { label: "2/17", iso: "2026-02-17" }, { label: "2/18", iso: "2026-02-18" },
            { label: "2/19", iso: "2026-02-19" }, { label: "2/20", iso: "2026-02-20" },
            { label: "2/21", iso: "2026-02-21" }, { label: "2/22", iso: "2026-02-22" },
            { label: "2/23", iso: "2026-02-23" },
        ];

        const INITIAL_EVENTS = [
            { id: "e1", date: "2026-02-13", time: "13:30", title: "TPE ‚Üí MNL (CI 703)", type: "transport", location: "Taoyuan Airport T1", shortDescription: "Âá∫ÁôºÔºÅËèØËà™È£õÈ¶¨Â∞ºÊãâÔºåÊ∫ñÂÇôËΩâÊ©ü„ÄÇ" },
            { id: "e2", date: "2026-02-13", time: "21:10", title: "MNL ‚Üí MEL (PR 209)", type: "transport", location: "Manila T1", shortDescription: "Ëè≤ÂæãË≥ìËà™Á©∫ÈÅéÂ§úÁè≠Ê©üÔºåÊ©ü‰∏äË£úÁú†„ÄÇ" },
            { id: "e3", date: "2026-02-14", time: "08:30", title: "ÊäµÈÅîÂ¢®ÁàæÊú¨ & Âá∫Èóú", type: "transport", location: "Tullamarine Airport", shortDescription: "ÈÄöÈóúÁ¥Ñ 1hr„ÄÇÈ†òË°åÊùé„ÄÅË≤∑ SkyBus„ÄÇ" },
            { id: "e4", date: "2026-02-14", time: "10:30", title: "Queen Victoria Market", type: "food", location: "Melbourne CBD", shortDescription: "Â¢®ÁàæÊú¨ÊúÄÂ§ßÂ∏ÇÈõÜÔºåÂêÉÊó©ÂçàÈ§ê„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1545465969-9c3dc1b61948?w=800", recommendedItems: ["Market Lane Coffee", "Bratwurst", "Doughnuts"] },
            { id: "e5", date: "2026-02-14", time: "14:00", title: "Fitzroy ÊñáÈùíÂçÄ", type: "activity", location: "Fitzroy", shortDescription: "Rose St. Market & Â°óÈ¥âÁâÜ„ÄÇ" },
            { id: "e6", date: "2026-02-14", time: "17:30", title: "St Kilda Êµ∑ÁÅò", type: "activity", location: "St Kilda", shortDescription: "Êê≠ Tram 96 ÂéªÊµ∑ÈÇäÁúãÂ§ïÈôΩ„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1557404768-305896a24683?w=800" },
            { id: "e7", date: "2026-02-15", time: "08:30", title: "Lune Croissanterie", type: "food", location: "Fitzroy", shortDescription: "‰∏ñÁïåÊúÄÂ•ΩÂêÉÂèØÈ†åÔºåÈúÄÊéíÈöä„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1527515637462-cff94eecc1ac?w=800", recommendedItems: ["Traditional", "Almond"] },
            { id: "e8", date: "2026-02-15", time: "10:30", title: "Melbourne Museum", type: "activity", location: "Carlton", shortDescription: "ÁöáÂÆ∂Â±ïË¶ΩÈ§® & ÊÅêÈæçÂçÄ„ÄÇ" },
            { id: "e9", date: "2026-02-15", time: "15:00", title: "Collingwood Yards", type: "activity", location: "Collingwood", shortDescription: "Áç®Á´ãÂ∞èÂ∫óËàá‰∏ãÂçàËå∂„ÄÇ" },
            { id: "e10", date: "2026-02-16", time: "10:00", title: "South Melbourne Market", type: "food", location: "South Melb", shortDescription: "ÂøÖÂêÉÁîüË†î„ÄÇ", recommendedItems: ["Dim Sims", "Oysters"] },
            { id: "e11", date: "2026-02-16", time: "14:00", title: "Yarra River & Southbank", type: "activity", location: "Southbank", shortDescription: "ÈõÖÊãâÊ≤≥Êï£Ê≠•„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1514395462725-fb456621614d?w=800" },
            { id: "e12", date: "2026-02-17", time: "09:00", title: "ÂèñËªä & Âá∫ÁôºÂ§ßÊ¥ãË∑Ø", type: "transport", location: "City Rental", shortDescription: "Ê™¢Êü•ËªäÊ≥ÅÔºåÂâçÂæÄ Geelong„ÄÇ" },
            { id: "e13", date: "2026-02-17", time: "12:00", title: "Great Ocean Road Drive", type: "activity", location: "B100", shortDescription: "Memorial Arch, Lorne, Kennett River„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1533293856238-d98a00632207?w=800" },
            { id: "e14", date: "2026-02-17", time: "17:00", title: "‰ΩèÂÆø Apollo Bay", type: "stay", location: "Apollo Bay", shortDescription: "Êµ∑ÈÇäÂ∞èÈéÆÊôöÈ§ê„ÄÇ" },
            { id: "e15", date: "2026-02-18", time: "06:30", title: "12 Apostles & Gibson", type: "activity", location: "Port Campbell", shortDescription: "Êó©Êô®ÈÅøÈñã‰∫∫ÊΩÆ„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1498964893798-29241da62136?w=800" },
            { id: "e16", date: "2026-02-18", time: "09:00", title: "Loch Ard Gorge", type: "activity", location: "Port Campbell", shortDescription: "Ê≤àËàπÂ≥ΩË∞∑„ÄÇ" },
            { id: "e17", date: "2026-02-18", time: "14:00", title: "ÂâçÂæÄ Grampians", type: "transport", location: "Halls Gap", shortDescription: "ÂÖßÈô∏ËªäÁ®ã 2.5hr„ÄÇ" },
            { id: "e18", date: "2026-02-18", time: "17:00", title: "‰ΩèÂÆø Grampians View", type: "stay", location: "Halls Gap", shortDescription: "ÂÇçÊôöÁúãË¢ãÈº†„ÄÇ" },
            { id: "e19", date: "2026-02-19", time: "06:00", title: "Boroka Lookout Êó•Âá∫", type: "activity", location: "Grampians", shortDescription: "ÁµïÊôØËßÄÊôØÂè∞„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1599827638593-38259f972b94?w=800" },
            { id: "e20", date: "2026-02-19", time: "09:00", title: "The Pinnacle Walk", type: "activity", location: "Wonderland", shortDescription: "Â≥ΩË∞∑Ê≠•ÈÅìÂÅ•Ë°å„ÄÇ" },
            { id: "e21", date: "2026-02-19", time: "14:00", title: "Mackenzie Falls", type: "activity", location: "Grampians", shortDescription: "Á∂≠Â∑ûÊúÄÂ§ßÁÄëÂ∏É„ÄÇ" },
            { id: "e22", date: "2026-02-20", time: "09:30", title: "Sovereign Hill", type: "activity", location: "Ballarat", shortDescription: "ÊéèÈáëÈéÆÈ´îÈ©ó„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1579763740266-9b1682335606?w=800" },
            { id: "e23", date: "2026-02-20", time: "15:00", title: "ÂâçÂæÄ MEL Ê©üÂ†¥ÈÇÑËªä", type: "transport", location: "MEL Airport", shortDescription: "Âä†ÊªøÊ≤π„ÄÅÈÇÑËªä„ÄÇ" },
            { id: "e24", date: "2026-02-20", time: "18:00", title: "È£õÂæÄÂ∏ÉÈáåÊñØÊú¨/ÈªÉÈáëÊµ∑Â≤∏", type: "flight", location: "MEL ‚Üí BNE/OOL", shortDescription: "Êê≠‰πòÂúãÂÖßÁ∑ö„ÄÇ" },
            { id: "e25", date: "2026-02-21", time: "09:00", title: "Surfers Paradise", type: "activity", location: "Gold Coast", shortDescription: "Ë°ùÊµ™ËÄÖÂ§©Â†Ç„ÄÇ", imageUrl: "https://images.unsplash.com/photo-1506973035872-a4ec16b8e8d9?w=800" },
            { id: "e26", date: "2026-02-21", time: "14:00", title: "Burleigh Heads", type: "activity", location: "Gold Coast", shortDescription: "Áï∂Âú∞‰∫∫‰ºëÈñíÂçÄ„ÄÇ" },
            { id: "e27", date: "2026-02-22", time: "10:00", title: "Brisbane South Bank", type: "activity", location: "Brisbane", shortDescription: "‰∫∫Â∑•Ê≤ôÁÅò Streets Beach„ÄÇ" },
            { id: "e28", date: "2026-02-22", time: "13:00", title: "Lone Pine Koala", type: "activity", location: "Brisbane", shortDescription: "Êä±ÁÑ°Â∞æÁÜä (ÈÅ∏ÈÖç)„ÄÇ" },
            { id: "e29", date: "2026-02-23", time: "14:00", title: "ÊúÄÂæåÊé°Ë≤∑", type: "activity", location: "Queen St Mall", shortDescription: "Ë≤∑‰º¥ÊâãÁ¶Æ„ÄÇ" },
            { id: "e30", date: "2026-02-23", time: "22:15", title: "BNE ‚Üí TPE (BR 316)", type: "transport", location: "Brisbane Airport", shortDescription: "ÂõûÂÆ∂ÂõâÔºÅ", imageUrl: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800" },
        ];

        // --- NEW: Highlighter Component ---
        const HighlightText = ({ text, highlight, className = "" }) => {
            if (!highlight.trim() || !text) return <span className={className}>{text}</span>;
            const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
            return (
                <span className={className}>
                    {parts.map((part, i) => 
                        part.toLowerCase() === highlight.toLowerCase() 
                            ? <span key={i} className="highlight">{part}</span> 
                            : part
                    )}
                </span>
            );
        };

        const TravelTimelineApp = () => {
            const [selectedDate, setSelectedDate] = useState(DATE_TABS[0].iso);
            const [expandedEventId, setExpandedEventId] = useState(null);
            const [events, setEvents] = useState([]);
            const [draggedEventId, setDraggedEventId] = useState(null);
            const [dragOverId, setDragOverId] = useState(null);
            const [droppedId, setDroppedId] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [processingImage, setProcessingImage] = useState(false);
            const [isSaved, setIsSaved] = useState(true);
            // NEW: Search State
            const [searchQuery, setSearchQuery] = useState("");

            // --- Countdown ---
            const daysToGo = useMemo(() => {
                const start = new Date(TRIP_START_DATE);
                const today = new Date();
                const diffTime = start - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }, []);
            const countdownText = daysToGo > 0 ? `${daysToGo} Days to Go` : (daysToGo === 0 ? "Trip is Today!" : `Day ${Math.abs(daysToGo) + 1} of Trip`);

            // --- Persistence ---
            useEffect(() => {
                try {
                    const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    setEvents(raw ? JSON.parse(raw) : INITIAL_EVENTS);
                } catch (e) { setEvents(INITIAL_EVENTS); }
            }, []);

            useEffect(() => {
                if (events.length > 0) {
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(events));
                        setIsSaved(true);
                        const timer = setTimeout(() => setIsSaved(false), 2000);
                        return () => clearTimeout(timer);
                    } catch (e) { console.error("Storage full", e); }
                }
            }, [events]);

            const now = new Date();
            
            // --- UPDATED: Search Filter Logic ---
            const eventsForSelectedDate = useMemo(() => {
                // First filter by Date
                let filtered = events.filter(e => e.date === selectedDate);
                
                // Then filter by Search Query (if any)
                if (searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(e => 
                        (e.title && e.title.toLowerCase().includes(q)) ||
                        (e.location && e.location.toLowerCase().includes(q)) ||
                        (e.shortDescription && e.shortDescription.toLowerCase().includes(q)) ||
                        (e.userNotes && e.userNotes.toLowerCase().includes(q))
                    );
                }
                return filtered; // Keep drag order (no time sort)
            }, [events, selectedDate, searchQuery]);

            const handleToggleChecked = (id) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, isCompleted: !ev.isCompleted } : ev));
            const handleNoteChange = (id, text) => setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, userNotes: text } : ev));
            const handleDeleteEvent = (id) => { if(confirm("Delete this event?")) setEvents(prev => prev.filter(ev => ev.id !== id)); };
            const handleUpdateField = (id, field, value) => { setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, [field]: value } : ev)); };

            const handleOpenMap = (location, title) => {
                const query = encodeURIComponent(`${location} ${title || ''}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            const handleImageUpload = (id, e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingImage(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; const MAX_HEIGHT = 800;
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } } 
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        setEvents(prev => prev.map(ev => ev.id === id ? { ...ev, images: [...(ev.images || []), compressedBase64] } : ev));
                        setProcessingImage(false);
                    };
                };
            };

            const handleDragStart = (e, id) => { 
                if (searchQuery) return; // Disable drag when searching
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
                setDraggedEventId(id); e.dataTransfer.effectAllowed = "move"; 
            };
            const handleDragOver = (e, id) => { e.preventDefault(); if (id !== draggedEventId && id !== dragOverId) setDragOverId(id); };
            const handleDragEnd = () => { setDraggedEventId(null); setDragOverId(null); };
            const handleDrop = (e, targetId) => {
                e.preventDefault(); setDragOverId(null);
                if (draggedEventId === targetId || searchQuery) { setDraggedEventId(null); return; }
                const currentList = events.filter(e => e.date === selectedDate);
                const fromIndex = currentList.findIndex(e => e.id === draggedEventId);
                const toIndex = currentList.findIndex(e => e.id === targetId);
                if (fromIndex === -1 || toIndex === -1) { setDraggedEventId(null); return; }
                const newList = [...currentList];
                const [moved] = newList.splice(fromIndex, 1);
                newList.splice(toIndex, 0, moved);
                const otherDaysEvents = events.filter(e => e.date !== selectedDate);
                setEvents([...otherDaysEvents, ...newList]);
                setDraggedEventId(null);
                setDroppedId(draggedEventId);
                setTimeout(() => setDroppedId(null), 600);
            };

            const handleAddEvent = (indexToInsert = -1) => {
                const newId = `new-${Date.now()}`;
                const newEvent = { id: newId, date: selectedDate, time: "12:00", title: "", type: "activity", location: "", shortDescription: "New item", isCompleted: false, images: [] };
                const currentList = events.filter(e => e.date === selectedDate);
                const otherDaysEvents = events.filter(e => e.date !== selectedDate);
                let newCurrentList = [...currentList];
                if (indexToInsert === -1) newCurrentList.push(newEvent); else newCurrentList.splice(indexToInsert, 0, newEvent);
                setEvents([...otherDaysEvents, ...newCurrentList]);
                setEditingId(newId);
                if (searchQuery) setSearchQuery(""); // Clear search to show new item
            };

            const getCategoryIcon = (type) => {
                if (type === 'transport') return <Plane className="text-blue-400" />;
                if (type === 'food') return <Utensils className="text-orange-400" />;
                if (type === 'stay') return <Bed className="text-purple-400" />;
                if (type === 'activity') return <Camera className="text-emerald-400" />;
                return <MapPin className="text-slate-400" />;
            };
            const typeLabels = { transport: "‰∫§ÈÄö", activity: "Ë°åÁ®ã", food: "ÁæéÈ£ü", stay: "‰ΩèÂÆø" };

            const AddZone = ({ index }) => (
                <div className="add-zone h-2 w-full flex items-center justify-center cursor-pointer group my-1 relative z-10" onClick={() => handleAddEvent(index)}>
                    <div className="w-full h-px bg-slate-800 group-hover:bg-blue-500/50 transition-colors relative"></div>
                    <div className="absolute bg-slate-900 border border-blue-500/50 text-blue-400 text-[10px] px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100 flex items-center gap-1 shadow-lg shadow-blue-900/20"><Plus size={12} /> Insert</div>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-950 text-slate-50 font-sans">
                    <header className="shrink-0 bg-slate-950/80 backdrop-blur border-b border-slate-800 p-4 pb-0 z-20 transition-all">
                        <div className="flex justify-between items-center mb-3">
                            <div><div className="text-[10px] tracking-widest text-slate-400 font-bold uppercase">2026 Trip Planner</div><h1 className="text-lg font-bold">Australia <span style={{color:PRIMARY_COLOR}}>Chill Trip</span></h1></div>
                            <div className="text-right flex flex-col items-end">
                                <div className="bg-blue-900/30 border border-blue-500/30 text-blue-300 text-[10px] px-2 py-1 rounded-full mb-1 font-bold">üê® {countdownText}</div>
                                <div className="text-xs text-slate-400">{now.toLocaleDateString()}</div>
                                <div className={`text-[10px] text-emerald-500 flex items-center gap-1 transition-opacity duration-500 ${isSaved ? "opacity-100" : "opacity-0"}`}><CloudCheck /> Saved</div>
                            </div>
                        </div>
                        
                        {/* DATE TABS */}
                        <div className="flex gap-2 overflow-x-auto pb-3 hide-scrollbar mb-1">
                            {DATE_TABS.map(d => (
                                <button key={d.iso} onClick={() => setSelectedDate(d.iso)} className={`shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition-all ${selectedDate === d.iso ? "text-slate-950 border-transparent scale-105" : "border-slate-800 text-slate-400"}`} style={{background: selectedDate === d.iso ? `linear-gradient(135deg, ${PRIMARY_COLOR}, ${PRIMARY_COLOR}dd)` : 'rgba(30,41,59,0.5)'}}>
                                    {d.label}
                                </button>
                            ))}
                        </div>

                        {/* SEARCH BAR (NEW) */}
                        <div className="relative mb-2">
                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><SearchIcon size={14}/></div>
                            <input 
                                type="text" 
                                placeholder="Search title, location, notes..." 
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-9 pr-8 text-xs text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-blue-500 transition-colors"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                            {searchQuery && (
                                <button onClick={() => setSearchQuery("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">
                                    <XIcon size={14}/>
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-20">
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 space-y-0 backdrop-blur-sm min-h-[300px]">
                            {eventsForSelectedDate.length === 0 && <div className="text-center py-10"><div className="text-slate-500 mb-2">{searchQuery ? "No matches found." : "No events today. üåø"}</div>{!searchQuery && <button onClick={() => handleAddEvent(-1)} className="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 transition-colors">+ Add First Event</button>}</div>}
                            
                            {!searchQuery && eventsForSelectedDate.length > 0 && <AddZone index={0} />}

                            {eventsForSelectedDate.map((ev, i) => {
                                const isCurrent = new Date(`${ev.date}T${ev.time}`).getTime() - now.getTime() < 3600000 && new Date(`${ev.date}T${ev.time}`).getTime() > now.getTime();
                                const isExpanded = expandedEventId === ev.id;
                                const isChecked = ev.isCompleted; 
                                const isDragging = draggedEventId === ev.id;
                                const isEditing = editingId === ev.id;
                                const isDragOver = dragOverId === ev.id;
                                const isJustDropped = droppedId === ev.id;

                                return (
                                    <React.Fragment key={ev.id}>
                                        <div 
                                            className={`flex gap-0 group relative transition-opacity duration-200 no-select event-card-wrapper ${isDragging ? "is-dragging rounded-xl overflow-hidden" : ""} ${isDragOver ? "drag-over-target" : ""} ${isJustDropped ? "pop-success" : ""}`}
                                            draggable={!isEditing && !searchQuery} // Disable drag when searching
                                            onDragStart={(e) => handleDragStart(e, ev.id)}
                                            onDragOver={(e) => handleDragOver(e, ev.id)}
                                            onDragEnd={handleDragEnd}
                                            onDrop={(e) => handleDrop(e, ev.id)}
                                        >
                                            <div className={`w-12 bg-slate-900 border-r border-slate-800 flex items-center justify-center shrink-0 rounded-l-xl ${searchQuery ? "opacity-30 cursor-not-allowed" : "drag-handle-zone group-hover:bg-slate-800 transition-colors"}`}>
                                                <GripVertical size={20} className="text-slate-500 group-hover:text-slate-300 transition-colors" />
                                            </div>
                                            <div className={`flex-1 border-y border-r border-slate-700 bg-slate-900/80 rounded-r-xl overflow-hidden transition-all relative ${isChecked ? "opacity-60 grayscale" : ""} ${isCurrent ? `ring-1 ring-[${PRIMARY_COLOR}] shadow-lg z-10` : ""}`} onClick={() => !isEditing && setExpandedEventId(isExpanded ? null : ev.id)}>
                                                <div className="p-3 pr-10">
                                                    <div className="flex justify-between items-start gap-3">
                                                        <div className="min-w-0 flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                {isEditing ? <input type="time" className="text-xs bg-slate-800 text-white border border-blue-500/50 rounded px-1 py-0 outline-none" value={ev.time} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'time', e.target.value)} /> : <span className={`font-mono text-xs cursor-pointer hover:text-blue-400 hover:underline decoration-dashed transition-colors ${isCurrent ? `text-[${PRIMARY_COLOR}] font-bold` : "text-slate-400"}`} onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} title="Click to Edit">{ev.time}</span>}
                                                                {isEditing ? <select className="text-[10px] bg-slate-800 border border-blue-500/50 rounded px-1 py-0 outline-none text-slate-300 ml-2" value={ev.type} onClick={(e) => e.stopPropagation()} onChange={(e) => handleUpdateField(ev.id, 'type', e.target.value)}><option value="transport">‰∫§ÈÄö</option><option value="activity">Ë°åÁ®ã</option><option value="food">ÁæéÈ£ü</option><option value="stay">‰ΩèÂÆø</option></select> : <span className="text-[10px] px-1.5 rounded border border-slate-700 text-slate-400 ml-2">{typeLabels[ev.type]}</span>}
                                                            </div>
                                                            {isEditing ? <div className="flex items-center gap-2 mt-1" onClick={e => e.stopPropagation()}><input type="text" className="bg-slate-800 border border-blue-500/50 rounded px-2 py-1 text-sm font-bold text-white w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.title} placeholder="Event Title..." autoFocus onChange={(e) => handleUpdateField(ev.id, 'title', e.target.value)} onKeyDown={(e) => e.key === 'Enter' && setEditingId(null)} /><button onClick={() => setEditingId(null)} className="bg-emerald-600/20 text-emerald-500 border border-emerald-600/50 p-1 rounded hover:bg-emerald-600 hover:text-white transition-colors"><Check size={16} /></button></div> 
                                                            : <h3 className="font-semibold truncate flex items-center gap-2 text-slate-100">
                                                                <span className="opacity-90 shrink-0">{getCategoryIcon(ev.type)}</span>
                                                                <span className="truncate block" onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }}>
                                                                    <HighlightText text={ev.title} highlight={searchQuery} />
                                                                </span>
                                                                <button onClick={(e) => { e.stopPropagation(); setEditingId(ev.id); }} className="opacity-0 group-hover:opacity-50 hover:!opacity-100 text-slate-500 transition-opacity ml-1"><Edit2 size={12} /></button>
                                                              </h3>}
                                                            <div className="flex items-center gap-2 mt-1 min-w-0">
                                                                {isEditing ? (
                                                                    <div className="flex items-center gap-1 w-full" onClick={e => e.stopPropagation()}>
                                                                        <MapPin size={12} className="text-slate-500 shrink-0" />
                                                                        <input type="text" className="bg-slate-800 text-xs border border-blue-500/50 rounded px-1 py-0.5 text-slate-300 w-full outline-none focus:ring-1 focus:ring-blue-500" value={ev.location || ""} placeholder="Enter location for map..." onChange={(e) => handleUpdateField(ev.id, 'location', e.target.value)} />
                                                                    </div>
                                                                ) : (
                                                                    ev.location && (
                                                                        <>
                                                                            <div className="flex items-center gap-1 min-w-0"><MapPin size={12} className="text-slate-400 shrink-0"/><span className="text-xs text-slate-400 truncate"><HighlightText text={ev.location} highlight={searchQuery} /></span></div>
                                                                            <button onClick={(e) => { e.stopPropagation(); handleOpenMap(ev.location, ev.title); }} className="text-blue-400 hover:text-blue-300 p-1 shrink-0 active:scale-95 transition-transform ml-1" title="Navigate with Google Maps"><MapIcon size={16} /></button>
                                                                        </>
                                                                    )
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {!isEditing && <p className="text-xs text-slate-300 mt-2 line-clamp-2"><HighlightText text={ev.shortDescription} highlight={searchQuery} /></p>}
                                                    <div className="absolute top-3 right-3 flex flex-col gap-2" onClick={e => e.stopPropagation()}>
                                                        <button onClick={() => handleToggleChecked(ev.id)} className={`w-8 h-8 rounded-full border flex items-center justify-center shrink-0 transition-all ${isChecked ? "bg-emerald-500/20 border-emerald-500 text-emerald-500" : "border-slate-700 text-slate-600 hover:bg-slate-800"}`}>{isChecked && "‚úì"}</button>
                                                        <button onClick={() => handleDeleteEvent(ev.id)} className="w-8 h-8 rounded-full border border-slate-700 text-slate-500 flex items-center justify-center hover:bg-red-500/20 hover:border-red-500 hover:text-red-500 transition-all"><Trash2 size={14} /></button>
                                                    </div>
                                                </div>
                                                {isExpanded && !isEditing && <div className="bg-slate-950/50 border-t border-slate-800 p-3 space-y-3 animate-in slide-in-from-top-2">
                                                    <textarea onClick={e=>e.stopPropagation()} value={ev.userNotes || ""} onChange={e=> handleNoteChange(ev.id, e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded-lg text-xs p-2 text-slate-200 focus:outline-none focus:border-[color:#3D9FBD]" placeholder="Notes..." rows={2}></textarea>
                                                    
                                                    {/* NOTES HIGHLIGHT PREVIEW (Only if searching) */}
                                                    {searchQuery && ev.userNotes && ev.userNotes.toLowerCase().includes(searchQuery.toLowerCase()) && (
                                                        <div className="text-xs p-2 bg-yellow-900/30 border border-yellow-700/50 rounded text-slate-300 mb-2">
                                                            Match in notes: "...<HighlightText text={ev.userNotes} highlight={searchQuery}/>..."
                                                        </div>
                                                    )}

                                                    {ev.imageUrl && <img src={ev.imageUrl} className="w-full h-32 object-cover rounded-lg border border-slate-700" />}
                                                    {ev.images?.map((src,k)=><img key={k} src={src} className="w-full h-24 object-cover rounded-lg border border-slate-700"/>)}
                                                    <label onClick={e=>e.stopPropagation()} className="block w-full py-2 border border-dashed border-slate-600 rounded-lg text-center text-xs text-slate-400 cursor-pointer hover:bg-slate-800"><span className="flex items-center justify-center gap-2"><ImageIcon size={14}/> {processingImage ? "Compressing..." : "Add Photo"}</span><input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(ev.id, e)}/></label>
                                                    <div className="flex justify-center"><ChevronUp size={16} className="text-slate-600"/></div>
                                                </div>}
                                            </div>
                                        </div>
                                        {!searchQuery && <AddZone index={i + 1} />}
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelTimelineApp />);
    </script>
</body>
</html>